<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Report</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/e8bddc60e73c1ec2475f827be36e1957af72e2ea/build/css/bootstrap-datetimepicker.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/jquery-easy-loading/dist/jquery.loading.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.10.12/css/dataTables.bootstrap.min.css"
      type="text/css"
    />
    <link rel="stylesheet" href="assets/css/style.css" type="text/css" />
  </head>

  <body>
    <div class="col-sm-6" style="margin-top: 15px;">
      <div class="panel panel-default panel-table">
        <div class="panel-heading">
          <span>Báo cáo nhập kho chi tiết</span>
          <span
            id="bt-refresh-nk"
            class="glyphicon glyphicon-refresh icbt-refresh"
            aria-hidden="true"
            title="Làm mới"
          ></span>
        </div>
        <div class="panel-body">
          <div class="table-filter">
            <div class="row">
              <div class="col-sm-6">
                <div class="form-group">
                  <div class="input-group date" id="dtp-nk-from">
                    <span class="input-group-addon">
                      Từ ngày
                    </span>
                    <input type="text" class="form-control" />
                    <span class="input-group-addon">
                      <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                  </div>
                </div>
              </div>
              <div class="col-sm-6">
                <div class="form-group">
                  <div class="input-group date" id="dtp-nk-to">
                    <span class="input-group-addon">
                      Đến ngày
                    </span>
                    <input type="text" class="form-control" />
                    <span class="input-group-addon">
                      <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="table-responsive">
            <table
              id="tb-nhapkho"
              class="table table-striped table-hover table-fw-widget"
              style="width: 100%"
            >
              <thead style="width: 100%">
                <tr>
                  <th>Thời gian</th>
                  <th>Tên vật tư</th>
                  <th>Tên nhân viên</th>
                  <th>Vị trí</th>
                  <th>Số lượng</th>
                </tr>
              </thead>
              <tfoot style="width: 100%">
                <tr>
                  <th>Thời gian</th>
                  <th>Tên vật tư</th>
                  <th>Tên nhân viên</th>
                  <th>Vị trí</th>
                  <th>Số lượng</th>
                </tr>
              </tfoot>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-6" style="margin-top: 15px;">
      <div class="panel panel-default panel-table">
        <div class="panel-heading">
          <span>Báo cáo xuất kho chi tiết</span>
          <span
            id="bt-refresh-xk"
            class="glyphicon glyphicon-refresh icbt-refresh"
            aria-hidden="true"
            title="Làm mới"
          ></span>
        </div>
        <div class="panel-body">
          <div class="table-filter">
            <div class="row">
              <div class="col-sm-6">
                <div class="form-group">
                  <div class="input-group date" id="dtp-xk-from">
                    <span class="input-group-addon">
                      Từ ngày
                    </span>
                    <input type="text" class="form-control" />
                    <span class="input-group-addon">
                      <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                  </div>
                </div>
              </div>
              <div class="col-sm-6">
                <div class="form-group">
                  <div class="input-group date" id="dtp-xk-to">
                    <span class="input-group-addon">
                      Đến ngày
                    </span>
                    <input type="text" class="form-control" />
                    <span class="input-group-addon">
                      <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="table-responsive">
            <table
              id="tb-xuatkho"
              class="table table-striped table-hover table-fw-widget"
              style="width: 100%"
            >
              <thead style="width: 100%">
                <tr>
                  <th>Thời gian</th>
                  <th>Tên vật tư</th>
                  <th>Tên nhân viên</th>
                  <th>Vị trí</th>
                  <th>Số lượng</th>
                </tr>
              </thead>
              <tfoot style="width: 100%">
                <tr>
                  <th>Thời gian</th>
                  <th>Tên vật tư</th>
                  <th>Tên nhân viên</th>
                  <th>Vị trí</th>
                  <th>Số lượng</th>
                </tr>
              </tfoot>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-sm-12">
      <div class="panel panel-default panel-table">
        <div class="panel-heading">
          <span>Kho vật tư y tế</span>
          <span
            id="bt-refresh-tk"
            class="glyphicon glyphicon-refresh icbt-refresh"
            aria-hidden="true"
            title="Làm mới"
          ></span>
        </div>
        <div class="panel-body">
          <div class="table-responsive">
            <table
              id="tb-tonkho"
              class="table table-striped table-hover table-fw-widget"
              style="width: 100%"
            >
              <thead style="width: 100%">
                <tr>
                  <th>STT</th>
                  <th>Tên vật tư</th>
                  <th>Nhập vào</th>
                  <th>Xuất ra</th>
                  <th>Tồn kho</th>
                </tr>
              </thead>
              <tfoot style="width: 100%">
                <tr>
                  <th>STT</th>
                  <th>Tên vật tư</th>
                  <th>Nhập vào</th>
                  <th>Xuất ra</th>
                  <th>Tồn kho</th>
                </tr>
              </tfoot>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.js"></script>
    <script src="https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/e8bddc60e73c1ec2475f827be36e1957af72e2ea/src/js/bootstrap-datetimepicker.js"></script>
    <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.5.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.5.6/js/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/1.10.19/api/sum().js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-easy-loading/dist/jquery.loading.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function() {
        Array.prototype.sum = function(prop) {
          var total = 0;
          for (var i = 0, _len = this.length; i < _len; i++) {
            total += this[i][prop];
          }
          return total;
        };

        const formatter = new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" });
        const timeformat = date => {
          const now = new Date(date),
            yyyy = now.getFullYear(),
            MM = now.getMonth() + 1,
            dd = now.getDate(),
            hh = now.getHours(),
            mm = now.getMinutes();
          const twoDigit = dg => {
            return dg < 10 ? "0" + dg : dg;
          };
          return `${twoDigit(dd)}/${twoDigit(MM)}/${yyyy} ${twoDigit(hh)}:${twoDigit(mm)}`;
        };

        const beginMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
        const currentTimeString = new Date().toISOString().replace(/T(.+)Z/, "T16:59:59Z");
        const currentTime = new Date(currentTimeString);

        const dtNKfrom = $("#dtp-nk-from").datetimepicker({
          locale: "vi",
          defaultDate: beginMonth
        });
        const dtNKto = $("#dtp-nk-to").datetimepicker({ locale: "vi", defaultDate: currentTime });

        const dtXKfrom = $("#dtp-xk-from").datetimepicker({
          locale: "vi",
          defaultDate: beginMonth
        });
        const dtXKto = $("#dtp-xk-to").datetimepicker({ locale: "vi", defaultDate: currentTime });

        let vietnamese = {
          sProcessing: "Đang xử lý...",
          sLengthMenu: "Hiển thị _MENU_ dòng",
          sZeroRecords: "Không tìm thấy dòng nào phù hợp",
          sInfo: "Từ _START_ đến _END_ trên tổng số _TOTAL_",
          sInfoEmpty: "Từ 0 đến 0 trên tổng số 0",
          sInfoFiltered: "(lọc từ _MAX_ kết quả)",
          sInfoPostFix: "",
          sSearch: "Tìm:",
          sUrl: "",
          oPaginate: {
            sFirst: "Đầu",
            sPrevious: "Trước",
            sNext: "Sau",
            sLast: "Cuối"
          }
        };

        let dataNhapKho = [];
        let dataXuatKho = [];
        let dataTonKho = [];

        // NHAP KHO
        const tbNhapKho = $("#tb-nhapkho").DataTable({
          buttons: ["excelHtml5", "pdfHtml5"],
          language: vietnamese,
          pageLength: 10,
          lengthMenu: [[6, 10, 25, 50, -1], [6, 10, 25, 50, "All"]],
          dom:
            "<'row be-datatable-header'<'col-sm-6'l><'col-sm-6'B>>" +
            "<'row be-datatable-body'<'col-sm-12'tr>>" +
            "<'row be-datatable-footer'<'col-sm-3'i><'col-sm-9'p>>",
          data: dataNhapKho,
          columns: [
            {
              data: "t",
              render: (data, type, row) => {
                return timeformat(data);
              }
            },
            { data: "TenVT", defaultContent: "___" },
            { data: "TenNV", defaultContent: "___" },
            { data: "c3" },
            {
              data: "c4",
              render: function(data, type, row, meta) {
                return row.DonVi * row.c4;
              }
            }
          ],
          order: [[0, "desc"]],
          processing: true,
          initComplete: function() {}
        });

        // XUAT KHO
        const tbXuatKho = $("#tb-xuatkho").DataTable({
          buttons: ["excelHtml5", "pdfHtml5"],
          language: vietnamese,
          pageLength: 10,
          lengthMenu: [[6, 10, 25, 50, -1], [6, 10, 25, 50, "All"]],
          dom:
            "<'row be-datatable-header'<'col-sm-6'l><'col-sm-6'B>>" +
            "<'row be-datatable-body'<'col-sm-12'tr>>" +
            "<'row be-datatable-footer'<'col-sm-3'i><'col-sm-9'p>>",
          data: dataXuatKho,
          columns: [
            {
              data: "t",
              render: (data, type, row) => {
                return timeformat(data);
              }
            },
            { data: "TenVT", defaultContent: "___" },
            { data: "TenNV", defaultContent: "___" },
            { data: "c3" },
            {
              data: "c4",
              render: function(data, type, row, meta) {
                return row.DonVi * row.c4;
              }
            }
          ],
          processing: true,
          order: [[0, "desc"]],
          initComplete: function() {}
        });

        // TON KHO
        const tbTonKho = $("#tb-tonkho").DataTable({
          buttons: ["excelHtml5", "pdfHtml5"],
          language: vietnamese,
          pageLength: 10,
          lengthMenu: [[6, 10, 25, 50, -1], [6, 10, 25, 50, "All"]],
          dom:
            "<'row be-datatable-header'<'col-sm-6'l><'col-sm-6'B>>" +
            "<'row be-datatable-body'<'col-sm-12'tr>>" +
            "<'row be-datatable-footer'<'col-sm-3'i><'col-sm-9'p>>",
          data: dataTonKho,
          columns: [
            {
              render: function(data, type, row, meta) {
                return meta.row + 1;
              }
            },
            { data: "TenVT" },
            {
              data: "input",
              render: function(data, type, row, meta) {
                return row.input * row.DonVi;
              }
            },
            {
              data: "output",
              render: function(data, type, row, meta) {
                return row.output * row.DonVi;
              }
            },
            {
              data: "DonVi",
              render: function(data, type, row, meta) {
                return row.input * row.DonVi - row.output * row.DonVi;
              }
            }
          ],

          processing: true,
          initComplete: function() {}
        });

        // GET NHAP KHO
        function getDataNK(from, to) {
          $("#tb-nhapkho").loading();
          fetch("/api/nhapkho", {
            method: "POST",
            credentials: "same-origin",
            headers: { "Content-Type": "application/json" },
            redirect: "follow",
            referrer: "no-referrer",
            body: JSON.stringify({
              fromdate: from,
              todate: to
            })
          })
            .then(res => {
              return res.json();
            })
            .then(res => {
              if (res.length > 0) {
                // Update table
                tbNhapKho.clear().draw();
                tbNhapKho.rows.add(res).draw();

                tbNhapKho.columns().every(function() {
                  var column = this;
                  var col = column.eq(0)[0];
                  if (col === 0 || col === 3 || col === 4) {
                    $('<select class="form-control" disabled></select>').appendTo(
                      $(column.footer()).empty()
                    );
                  } else {
                    var select = $(
                      '<select class="form-control"><option value=""></option></select>'
                    )
                      .appendTo($(column.footer()).empty())
                      .on("change", function() {
                        var val = $.fn.dataTable.util.escapeRegex($(this).val());
                        let search = column.search(val ? "^" + val + "$" : "", true, false).draw();
                      });
                    column
                      .data()
                      .unique()
                      .sort()
                      .each(function(d, j) {
                        select.append('<option value="' + d + '">' + d + "</option>");
                      });
                  }
                });

                $("#tb-nhapkho").loading("toggle");
              } else {
                tbNhapKho.clear().draw();
                tbNhapKho.columns().every(function() {
                  var column = this;
                  var select = $(
                    '<select class="form-control"><option value=""></option></select>'
                  ).appendTo($(column.footer()).empty());
                });
                $("#tb-nhapkho").loading("toggle");
              }
            });
        }

        // GET XUAT KHO
        function getDataXK(from, to) {
          $("#tb-xuatkho").loading();
          fetch("/api/xuatkho", {
            method: "POST",
            credentials: "same-origin",
            headers: { "Content-Type": "application/json" },
            redirect: "follow",
            referrer: "no-referrer",
            body: JSON.stringify({
              fromdate: from,
              todate: to
            })
          })
            .then(res => {
              return res.json();
            })
            .then(res => {
              if (res.length > 0) {
                // Update table
                tbXuatKho.clear().draw();
                tbXuatKho.rows.add(res).draw();

                tbXuatKho.columns().every(function() {
                  var column = this;
                  var col = column.eq(0)[0];
                  if (col === 0 || col === 3 || col === 4) {
                    $('<select class="form-control" disabled></select>').appendTo(
                      $(column.footer()).empty()
                    );
                  } else {
                    var select = $(
                      '<select class="form-control"><option value=""></option></select>'
                    )
                      .appendTo($(column.footer()).empty())
                      .on("change", function() {
                        var val = $.fn.dataTable.util.escapeRegex($(this).val());
                        let search = column.search(val ? "^" + val + "$" : "", true, false).draw();
                      });
                    column
                      .data()
                      .unique()
                      .sort()
                      .each(function(d, j) {
                        select.append('<option value="' + d + '">' + d + "</option>");
                      });
                  }
                });

                $("#tb-xuatkho").loading("toggle");
              } else {
                tbXuatKho.clear().draw();
                tbXuatKho.columns().every(function() {
                  var column = this;
                  var select = $(
                    '<select class="form-control"><option value=""></option></select>'
                  ).appendTo($(column.footer()).empty());
                });
                $("#tb-xuatkho").loading("toggle");
              }
            });
        }

        // GET TON KHO
        function getDataTK() {
          $("#tb-tonkho").loading();
          fetch("/api/tonkho", {
            method: "POST",
            credentials: "same-origin",
            headers: { "Content-Type": "application/json" },
            redirect: "follow",
            referrer: "no-referrer",
            body: JSON.stringify({})
          })
            .then(res => {
              return res.json();
            })
            .then(res => {
              if (res.length > 0) {
                // Update table
                tbTonKho.clear().draw();
                tbTonKho.rows.add(res).draw();

                tbTonKho.columns().every(function() {
                  var column = this;
                  var col = column.eq(0)[0];
                  if (col === 0 || col === 2 || col === 3 || col === 4) {
                    $('<select class="form-control" disabled></select>').appendTo(
                      $(column.footer()).empty()
                    );
                  } else {
                    var select = $(
                      '<select class="form-control"><option value=""></option></select>'
                    )
                      .appendTo($(column.footer()).empty())
                      .on("change", function() {
                        var val = $.fn.dataTable.util.escapeRegex($(this).val());
                        let search = column.search(val ? "^" + val + "$" : "", true, false).draw();
                      });
                    column
                      .data()
                      .unique()
                      .sort()
                      .each(function(d, j) {
                        select.append('<option value="' + d + '">' + d + "</option>");
                      });
                  }
                });

                $("#tb-tonkho").loading("toggle");
              } else {
                tbTonKho.clear().draw();
                tbTonKho.columns().every(function() {
                  var column = this;
                  var select = $(
                    '<select class="form-control"><option value=""></option></select>'
                  ).appendTo($(column.footer()).empty());
                });
                $("#tb-tonkho").loading("toggle");
              }
            });
        }

        $("#bt-refresh-nk").click(() => {
          let dtpfrom = $("#dtp-nk-from")
            .data("DateTimePicker")
            .date();
          let fromtime = new Date(dtpfrom._d);
          let dtpto = $("#dtp-nk-to")
            .data("DateTimePicker")
            .date();
          let totime = new Date(dtpto._d);

          getDataNK(fromtime.toISOString(), totime.toISOString());
        });

        $("#bt-refresh-xk").click(() => {
          let dtpfrom = $("#dtp-xk-from")
            .data("DateTimePicker")
            .date();
          let fromtime = new Date(dtpfrom._d);
          let dtpto = $("#dtp-xk-to")
            .data("DateTimePicker")
            .date();
          let totime = new Date(dtpto._d);

          getDataXK(fromtime.toISOString(), totime.toISOString());
        });

        $("#bt-refresh-tk").click(() => {
          getDataTK();
        });

        dtNKfrom.on("dp.change", e => {
          let dtpto = $("#dtp-nk-to")
            .data("DateTimePicker")
            .date();
          let fromtime = new Date(e.date._d);
          let totime = new Date(dtpto._d);

          getDataNK(fromtime.toISOString(), totime.toISOString());
        });

        dtNKto.on("dp.change", e => {
          let dtpfrom = $("#dtp-nk-from")
            .data("DateTimePicker")
            .date();
          let totime = new Date(e.date._d);
          let fromtime = new Date(dtpfrom._d);

          getDataNK(fromtime.toISOString(), totime.toISOString());
        });

        dtXKfrom.on("dp.change", e => {
          let dtpto = $("#dtp-xk-to")
            .data("DateTimePicker")
            .date();
          let fromtime = new Date(e.date._d);
          let totime = new Date(dtpto._d);

          getDataXK(fromtime.toISOString(), totime.toISOString());
        });

        dtXKto.on("dp.change", e => {
          let dtpfrom = $("#dtp-xk-from")
            .data("DateTimePicker")
            .date();
          let totime = new Date(e.date._d);
          let fromtime = new Date(dtpfrom._d);

          getDataXK(fromtime.toISOString(), totime.toISOString());
        });

        getDataNK(beginMonth.toISOString(), currentTime.toISOString());
        getDataXK(beginMonth.toISOString(), currentTime.toISOString());
        getDataTK();
      });
    </script>
  </body>
</html>
